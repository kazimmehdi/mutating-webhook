# helm-chart/templates/certificate-generator-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mutating-webhook.fullname" . }}-cert-script
  labels:
    {{- include "mutating-webhook.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook-delete-policy": before-hook-creation
data:
  generate-certs.sh: |
    #!/bin/bash
    set -e

    SERVICE_NAME="{{ include "mutating-webhook.fullname" . }}"
    NAMESPACE="{{ .Release.Namespace }}"
    DAYS_VALID="{{ .Values.certificate.daysValid }}"
    ORGANIZATION="{{ .Values.certificate.organization }}"
    COMMON_NAME="{{ .Values.certificate.commonName }}"
    
    if [ -z "$COMMON_NAME" ]; then
      COMMON_NAME="${SERVICE_NAME}.${NAMESPACE}.svc"
    fi

    echo "======================================"
    echo "Generating certificates for webhook"
    echo "======================================"
    echo "Service: ${SERVICE_NAME}"
    echo "Namespace: ${NAMESPACE}"
    echo "Common Name: ${COMMON_NAME}"
    echo "Validity: ${DAYS_VALID} days"
    echo "======================================"

    # Create temp directory
    TEMP_DIR=$(mktemp -d)
    cd $TEMP_DIR

    # Generate CA private key
    echo "Generating CA private key..."
    openssl genrsa -out ca.key 2048

    # Generate CA certificate
    echo "Generating CA certificate..."
    openssl req -x509 -new -nodes -key ca.key \
      -subj "/CN=${COMMON_NAME}-ca/O=${ORGANIZATION}" \
      -days ${DAYS_VALID} \
      -out ca.crt

    # Generate server private key
    echo "Generating server private key..."
    openssl genrsa -out tls.key 2048

    # Create OpenSSL config for SAN
    cat > csr.conf <<EOF
    [req]
    req_extensions = v3_req
    distinguished_name = req_distinguished_name
    [req_distinguished_name]
    [v3_req]
    basicConstraints = CA:FALSE
    keyUsage = nonRepudiation, digitalSignature, keyEncipherment
    extendedKeyUsage = serverAuth
    subjectAltName = @alt_names
    [alt_names]
    DNS.1 = ${SERVICE_NAME}
    DNS.2 = ${SERVICE_NAME}.${NAMESPACE}
    DNS.3 = ${SERVICE_NAME}.${NAMESPACE}.svc
    DNS.4 = ${SERVICE_NAME}.${NAMESPACE}.svc.cluster.local
    EOF

    # Generate Certificate Signing Request
    echo "Generating certificate signing request..."
    openssl req -new -key tls.key \
      -subj "/CN=${COMMON_NAME}/O=${ORGANIZATION}" \
      -out tls.csr \
      -config csr.conf

    # Sign the certificate
    echo "Signing certificate with CA..."
    openssl x509 -req -in tls.csr \
      -CA ca.crt -CAkey ca.key \
      -CAcreateserial \
      -out tls.crt \
      -days ${DAYS_VALID} \
      -extensions v3_req \
      -extfile csr.conf

    echo "Certificate generation completed successfully!"

    # Verify certificate
    echo ""
    echo "Certificate Details:"
    openssl x509 -in tls.crt -text -noout | grep -A 1 "Subject:"
    openssl x509 -in tls.crt -text -noout | grep -A 3 "Subject Alternative Name"

    # Create or update Kubernetes secret
    echo ""
    echo "Creating/updating Kubernetes secret..."
    
    # Check if secret exists
    if kubectl get secret {{ include "mutating-webhook.fullname" . }}-cert -n ${NAMESPACE} > /dev/null 2>&1; then
      echo "Secret exists, deleting..."
      kubectl delete secret {{ include "mutating-webhook.fullname" . }}-cert -n ${NAMESPACE}
    fi

    # Create secret
    kubectl create secret generic {{ include "mutating-webhook.fullname" . }}-cert \
      -n ${NAMESPACE} \
      --from-file=tls.crt=tls.crt \
      --from-file=tls.key=tls.key \
      --from-file=ca.crt=ca.crt

    echo "Secret created successfully!"

    # Update MutatingWebhookConfiguration with CA bundle
    echo ""
    echo "Updating MutatingWebhookConfiguration with CA bundle..."
    
    # Encode CA certificate in base64
    CA_BUNDLE=$(cat ca.crt | base64 | tr -d '\n')
    
    # Wait for MutatingWebhookConfiguration to exist (it's created by post-install hook)
    echo "Waiting for MutatingWebhookConfiguration to be created..."
    for i in {1..30}; do
      if kubectl get mutatingwebhookconfiguration {{ include "mutating-webhook.fullname" . }} > /dev/null 2>&1; then
        echo "MutatingWebhookConfiguration found!"
        break
      fi
      echo "Waiting... ($i/30)"
      sleep 2
    done

    # Patch the webhook configuration
    kubectl patch mutatingwebhookconfiguration {{ include "mutating-webhook.fullname" . }} \
      --type='json' \
      -p="[{\"op\": \"replace\", \"path\": \"/webhooks/0/clientConfig/caBundle\", \"value\":\"${CA_BUNDLE}\"}]"

    echo ""
    echo "======================================"
    echo "Certificate generation complete!"
    echo "======================================"

    # Cleanup
    cd /
    rm -rf $TEMP_DIR
